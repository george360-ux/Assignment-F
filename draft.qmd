---
title: "Strawberries_Draft"
author: "George Acostalemus"
format: pdf
editor: visual
---

## Introduction

Strawberries are one of the most widely cultivated fruit crops in the United States, with production heavily concentrated in states such as California and Florida. To sustain high yields and consistent quality, strawberry growers depend on fertilizers to supply essential plant nutrients. However, fertilizer use also raises important questions about environmental impact, soil health, and sustainbility. This project analyzes data on strawberry fertilizer use across US states. The goal is to explore patterns, trends, and potential pros/cons of different fertilizer type including Nitrogen, Phosphate, Potash and Sulfur to understand how these inputs vary by geography and time.

We begin by cleaning and structuring the data to ensure technical correctness, then conduct exploratory analyses that focus on:

-   Usage distribution by fertilizer type

-   Geographic difference in fertilizer use

-   Trends in fertilizer use over time

-   Relationships among fertilizer types

The approach follows a structured analytically strategy

1.  Clean → 2. Explore → 3. Interpret → 4. Report

The purpose of the exploratory data analysis is to not draw conclusion but to hopefully have a better understanding on how fertilizer use reflects broader management practices in strawberry agriculture. The results can serve as a foundation for future work linking fertilizer management to yield, soil health and environmental sustainability.

## Raw Data and Acquisition

The data set was provided by the USDA Strawberry Production Survey. It contains information about fertilizer application types, quantities, and related descriptors by US states and year.

Fertilizer use is a key input determining yield and environmental impact. Comparing fertilizer types (organic vs conventional) provides insight into production sustainability. We are looking at comparison between organic and conventional strawberries. Fertilizers used in the strawberries are used to determine organic and conventional products

| Chemical | Role | Typical Form | Organic Status |
|------------------|------------------|------------------|------------------|
| Nitrogen (N) | Leaf/vegetative growth | Urea, Ammonium Nitrate | Not organic unless it came from compost |
| Phosphate (P) | Root development | Superphosphate | Synthetic |
| Potash (K) | Disease resistance | Potassium chlroride or Sulfate | Natural forms like potassium from mineral sources can be organic |
| Sulfur (S) | Disease control | Elemental sulfur | Allows in orgnanic systems if naturally derived |

To achieve data a technically correct data-set, we implemented a modular cleaning pipeline that

-   Standardized column names

-   Trimmed white spaces and punctuation

-   Removed uninformative columns (state_ansi, constant columns)

-   Passed numeric columns safely

-   Cleaned text fields (data_item, domain_category -\> fertilizer)

-   Removed NA and zero values

```{r}
#| label: Library of cleaning functions
#| # Load in the packages
library(tidyverse)
library(janitor)
library(stringr)

# Clean column names
clean_column_names <- function(df) {
  df %>% janitor::clean_names()
}

# Remove empty or constant columns
remove_empty_constant_cols <- function(df) {
  df %>%
    dplyr::select_if(function(col) !all(is.na(col))) %>%
    dplyr::select_if(function(col) dplyr::n_distinct(col, na.rm = TRUE) > 1)
}

# Trim whitespace
trim_whitespace <- function(df) {
  df %>% mutate(across(where(is.character), str_trim))
}

# Clean data_item (keep as data_item)
clean_data_item <- function(df) {
  if (!"data_item" %in% names(df)) return(df)
  df %>%
    mutate(
      # Remove leading commodity prefix like "STRAWBERRIES - " or "STRAWBERRIES, "
      data_item = str_remove(data_item, regex("^STRAWBERRIES(\\s*-\\s*|,\\s*)", ignore_case = TRUE)),
      # Remove trailing "MEASURED ..." phrases
      data_item = str_remove(data_item, regex(",\\s*MEASURED.*$", ignore_case = TRUE)),
      data_item = str_remove(data_item, regex("\\bMEASURED.*$", ignore_case = TRUE)),
      # Normalize punctuation and whitespace
      data_item = str_replace_all(data_item, "[-_]+", " "),
      data_item = str_replace_all(data_item, "[()\\[\\]\\:]", ""), # easier to strip here
      data_item = str_squish(data_item),
      data_item = str_to_title(data_item)
    )
}

# Rename domain_category -> fertilizer and clean it
clean_domain_to_fertilizer <- function(df) {
  # Only do this if domain_category exists
  if (!"domain_category" %in% names(df)) return(df)
  
  df %>%
    # rename first to avoid accidental overwrites
    rename(fertilizer = domain_category) %>%
    mutate(
      # remove leading "FERTILIZER:" or similar
      fertilizer = str_remove(fertilizer, regex("^FERTILIZER[:\\s\\-]*", ignore_case = TRUE)),
      # If fertilizer info is inside parentheses like "FERTILIZER: (NITROGEN)" extract inside
      fertilizer = str_replace(fertilizer, regex("^\\s*\\(([^)]+)\\).*", ignore_case = TRUE), "\\1"),
      # remove trailing measured/unit phrases
      fertilizer = str_remove(fertilizer, regex(",\\s*MEASURED.*$", ignore_case = TRUE)),
      fertilizer = str_remove(fertilizer, regex("\\bMEASURED.*$", ignore_case = TRUE)),
      # remove extra punctuation
      fertilizer = str_remove_all(fertilizer, "[()\\[\\]]"),
      fertilizer = str_replace_all(fertilizer, "[-_]+", " "),
      fertilizer = str_squish(fertilizer),
      fertilizer = str_to_title(fertilizer)
    )
}

# Numeric detection & cleaning (skip identifier and fertilizer)
clean_numeric_value <- function(df) {
  numeric_prop <- sapply(df, function(col) {
    col_chr <- as.character(col)
    col_chr[col_chr == ""] <- NA
    col_clean <- gsub(",", "", col_chr)
    num <- suppressWarnings(as.numeric(col_clean))
    mean(!is.na(num))
  })
  
  ignore_cols <- c(
    "year","state","state_ansi","ag_district_code","county_ansi",
    "watershed_code","domain","domain_category","week","month","location","fertilizer","data_item"
  )
  numeric_prop <- numeric_prop[!names(numeric_prop) %in% ignore_cols]
  
  if (all(is.na(numeric_prop)) || length(numeric_prop) == 0) {
    potential <- c("value","amount","estimate","quantity","tons","kg","lbs")
    potential_found <- intersect(names(df), potential)
    if (length(potential_found) > 0) {
      best_candidate <- potential_found[1]
    } else {
      stop("No suitable numeric column detected. Check your data headers.")
    }
  } else {
    best_candidate <- names(numeric_prop)[which.max(numeric_prop)]
  }
  
  message("Detected numeric column: ", best_candidate)
  
  df <- df %>%
    mutate(
      !!best_candidate := suppressWarnings(as.numeric(gsub(",", "", .data[[best_candidate]])))
    )
  
  if (!"value" %in% names(df) && best_candidate != "value") {
    df <- df %>% rename(value = !!sym(best_candidate))
  }
  df
}

# Convert types safely
convert_data_types <- function(df) {
  df %>%
    mutate(
      state = if ("state" %in% names(.)) as.factor(state) else state,
      year  = if ("year" %in% names(.)) as.integer(year) else year,
      fertilizer = if ("fertilizer" %in% names(.)) as.factor(fertilizer) else fertilizer,
      data_item = if ("data_item" %in% names(.)) as.factor(data_item) else data_item
    )
}

# Final cleanup
final_cleanup <- function(df) {
  df %>%
    filter(!is.na(value) & value > 0) %>%
    distinct()
}

# Final master pipeline
clean_strawberry_fertilizer <- function(path,
                                       drop_state_ansi = TRUE,
                                       save_clean = FALSE,
                                       save_path = "strawberry_fertilizers_clean.csv") {
  df <- read_csv(path, show_col_types = FALSE) %>%
    clean_column_names()
  
  if (drop_state_ansi) {
    df <- df %>% dplyr::select(-dplyr::any_of("state_ansi"))
  }
  
  df <- df %>%
    remove_empty_constant_cols() %>%
    trim_whitespace() %>%
    clean_data_item() %>%            # clean raw data_item (keeps as data_item)
    clean_domain_to_fertilizer() %>% # rename domain_category -> fertilizer and clean it
    clean_numeric_value() %>%
    convert_data_types() %>%
    final_cleanup()
  
  if (save_clean) write_csv(df, save_path)
  df
}

# Example usage:
fert_clean <- clean_strawberry_fertilizer("~/Documents/MA-615/strawberry_fertilizers.csv", drop_state_ansi = TRUE)
glimpse(fert_clean)
unique(fert_clean$fertilizer)
unique(fert_clean$data_item)

# Part of the code was edited through chatGPT to make it run successfully

```

# Exploratory Data Analysis 

Overview of Fertilizer Types

```{r}
fert_clean %>%count(fertilizer, sort = TRUE)
```

Nitrogen and Potash appear as the most frequently reported fertilizers, suggesting they are the core components of conventional strawberry farming.

**Geographic Patterns**

```{r}
fert_state <- fert_clean %>% 
  group_by(state, fertilizer) %>% 
  summarise(mean_value = mean(value, na.rm = T), .groups = "drop")

ggplot(fert_state, aes(x = reorder(state, mean_value), y = mean_value, fill = fertilizer)) +
  geom_bar(stat = "identity", position = "dodge") +
  coord_flip() +
  labs(
    title = "Average Fertilizer Use by State",
    x = "State",
    y = "Average Use"
  ) +
  theme_minimal()
  
```

California lead in fertilizer use reflecting their large strawberry industries.

```{r}
fert_clean %>%
  group_by(year, fertilizer) %>%
  summarise(mean_value = mean(value, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = year, y = mean_value, color = fertilizer)) +
  geom_line(size = 1.2) +
  geom_point() +
  theme_minimal() +
  labs(title = "Fertilizer Use Over Time", y = "Average Use", x = "Year")
```

Phosphate use appears stable across years, but for all fertilizers, there is a spiked trend upwards from mid to late 2010s which could mean some outliers in the data set.

The data set captures fertilizer usage primarily in conventional strawberry production system where the fertilizers are applied. In contrast, organic strawberry systems rely on nutrient source like composted manure or mineral sulfur rather than synthetic chemicals. This distinction matters because organic fertilizer release nutrients slowly and improve soil health, while conventional systems enable rapid growth but may pose environmental risks such as nitrate leaching and reduced soil biodiversity.

**Conclusion**

This exploratory analysis provides an initial understanding of fertilizer use patterns in the US strawberry production:

-   Nitrogen and Potash dominate national usage

-   Fertilizer intensity is highest in major production states

-   Some fertilizers show correlated application patterns.

This report demonstrates the potential of fertilizer-use data to inform sustainability discussion in agriculture. However, a complete understanding of pros and cons requires linking fertilizer to other variables such as yield, soil quality, and economic return. Future analyses should incorporate these dimensions, along with spatial or weather data to assess fertilizer efficiency and environmental performance more directly. Future steps are our group continue with our analysis is to include linking fertilizer inputs to yield and environmental indicators to evaluate efficiency and sustainability discussions in agriculture.

Sources to be cited:

-   Data source: U.S. Department of Agriculture (USDA). *Strawberry Chemical Use Survey Dataset, 2025.*

-   Soil Science Society of America. *Nutrient Management and Environmental Impact.*

-   UC Davis Extension. *Fertilizer Management in Berry Production.*

**DATA CLEAN REDO**

```{r}
library(tidyverse)

raw <- read_csv("~/Documents/MA-615/strawberry_fertilizers.csv", show_col_types = FALSE)
unique(raw$`Data Item`)[1:20]

library(dplyr)
library(stringr)

fert_expanded <- raw %>%
  mutate(
    fertilizer_type = str_extract(`Domain Category`, "(?<=FERTILIZER[:\\s\\(\\-]*)([A-Z]+)(?=[\\)\\,])"),
    fertilizer_type = str_to_title(fertilizer_type),
    measurement = str_extract(`Data Item`, "(?<=MEASURED IN\\s)(.*)"),
    measurement = str_squish(measurement)
  )

head(fert_expanded %>% select(`Data Item`, fertilizer_type, measurement))

```
